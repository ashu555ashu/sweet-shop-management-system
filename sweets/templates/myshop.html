{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Sweets Shop</title>
    <style>
        body { margin: 0; font-family: Arial; background: #f5f5f5; padding: 20px; }

        /* NAVBAR */
        .navbar { width: 100%; background: #00a2ff; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .brand { display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 50px; height: 50px; border-radius: 50%; overflow: hidden; background: white; display: flex; align-items: center; justify-content: center;}
        .logo-icon img { width: 100%; height: 100%; object-fit: contain; }
        .brand-name { font-size: 22px; font-weight: 700; }
        .right-icons { display: flex; align-items: center; gap: 10px; }
        .profile-icon, .cart-icon { width: 40px; height: 40px; border-radius: 50%; overflow: hidden; background: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .profile-icon img, .cart-icon img { width: 100%; height: 100%; object-fit: cover; }

        /* SEARCH */
        .search-bar { margin: 20px 0; text-align: center; }
        .search-bar input { padding: 10px 15px; width: 300px; border-radius: 25px; border: 1px solid #ccc; }
        .search-bar button { padding: 10px 20px; border-radius: 25px; border: none; background: #ff4f9a; color: #fff; cursor: pointer; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        th { background: #00a2ff; color: white; }
        img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }

        /* BUTTONS */
        .action-btn { padding: 5px 10px; border-radius: 5px; color: white; border: none; cursor: pointer; margin: 2px; }
        .buy-btn { background: #ff4f9a; }
        .buy-btn:hover { background: #ff2f88; }
        .edit-btn { background: #00a2ff; }
        .edit-btn:hover { background: #007acc; }
        .delete-btn { background: #ff0000; }
        .delete-btn:hover { background: #cc0000; }
        .restock-btn { background: #28a745; }
        .restock-btn:hover { background: #218838; }
        .table-btn {
    padding: 6px 12px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: 0.2s ease;
    margin-right: 5px;
}

/* Edit button */
.table-btn.edit {
    background-color: #00a2ff;
    color: rgb(255, 255, 255);
}
.table-btn.edit:hover {
    background-color: #007acc;
}

/* Delete button */
.table-btn.delete {
    background-color: #ff4f4f;
    color: rgb(241, 241, 241);
}
.table-btn.delete:hover {
    background-color: #cc0000;
}

/* Restock button */
.table-btn.restock {
    background-color: #4caf50;
    color: white;
}
.table-btn.restock:hover {
    background-color: #2e7d32;
}

/* Optional: Table styling */
#sweetsTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: white;
}

#sweetsTable th, #sweetsTable td {
    padding: 10px 15px;
    border: 1px solid #ddd;
    text-align: center;
}

#sweetsTable th {
    background-color: #00a2ff;
    color: white;
}

    </style>
</head>
<body>

<!-- NAVBAR -->
<div class="navbar">
    <div class="brand">
        <div class="logo-icon">
        <img src="{% static 'shop/images/logo.png' %}" alt="Sweets Shop">
        </div>
        <div class="brand-name">Sweets Shop</div>
    </div>
    <div class="right-icons">
        <div class="profile-icon">
        <img src="{% static 'shop/images/profile.png' %}" alt="Profile">
        </div>
        <div class="cart-icon">
        <img src="{% static 'shop/images/add.png' %}" alt="Cart">
        </div>
    </div>
  
</div>

<!-- SEARCH + ADD SWEET BUTTON -->
<div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search sweets...">
    <button onclick="searchSweets()">Search</button>
    {% if request.user.is_staff %}
        <button onclick="window.location.href='{% url 'sweet:add_sweet' %}'" 
                style="margin-left:10px; padding:10px 20px; border-radius:25px; background:#28a745; color:white; border:none; cursor:pointer;">
            Add Sweet
        </button>
    {% endif %}
</div>

<!-- SWEETS TABLE -->
<table id="sweetsTable">
    <thead>
        <tr>
            <th>Photo</th>
            <th>Name</th>
            <th>Description</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for sweet in sweets %}
        <tr>
             <td>
                {% if sweet and sweet.photo %}
                <img src="{{ MEDIA_URL }}{{ sweet.photo }}" class="existing-photo" alt="Existing Photo">
                {% endif %}

            </td>
            <td>{{ sweet.name }}</td>
            <td>{{ sweet.description }}</td>
            <td>₹{{ sweet.price }}</td>
            <td>{{ sweet.quantity }}</td>
            <td style="display:flex; gap:5px; align-items:center;">
                <button class="table-btn edit" onclick="window.location.href='{% url 'sweet:edit_sweet' sweet.id %}'">Edit</button>
                <button class="table-btn delete" onclick="if(confirm('Delete this sweet?')) window.location.href='{% url 'sweet:delete_sweet' sweet.id %}'">Delete</button>
                
                <!-- Restock Form -->
                <form method="POST" action="{% url 'sweet:restock_sweet' sweet.id %}" style="display:flex; gap:5px; align-items:center;">
                    {% csrf_token %}
                    <input type="number" name="quantity" min="1" placeholder="+Qty" class="qty-input" required>
                    <button class="table-btn restock">Restock</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    const sweetsTableBody = document.querySelector('#sweetsTable tbody');

    const isAdmin = {{ request.user.is_staff|yesno:"true,false" }};

    async function fetchSweets() {
        const res = await fetch('/shop/api/sweets/');
        const data = await res.json();
        renderSweets(data);
    }

    async function searchSweets() {
        const query = document.getElementById('searchInput').value;
        const res = await fetch(`/shop/api/sweets/search/?q=${query}`);
        const data = await res.json();
        renderSweets(data);
    }

    function renderSweets(sweets) {
        sweetsTableBody.innerHTML = '';
        sweets.forEach(sweet => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><img src="${sweet.image || 'https://via.placeholder.com/50'}" alt="${sweet.name}"></td>
                <td>${sweet.name}</td>
                <td>${sweet.description || ''}</td>
                <td>₹${sweet.price}</td>
                <td>${sweet.quantity}</td>
                <td>
                    <button class="action-btn buy-btn" onclick="purchaseSweet(${sweet.id})">Buy</button>
                    <button class="action-btn edit-btn" onclick="window.location.href='/shop/edit/${sweet.id}/'">Edit</button>
                    <button class="action-btn delete-btn" onclick="deleteSweet(${sweet.id})">Delete</button>
                    ${isAdmin ? `<button class="action-btn restock-btn" onclick="restockSweet(${sweet.id})">Restock</button>` : ''}
                </td>
            `;
            sweetsTableBody.appendChild(tr);
        });
    }


    async function restockSweet(id) {
        const qty = prompt('Enter quantity to restock:');
        if (!qty) return;
        const res = await fetch(`/shop/api/sweets/${id}/restock/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ quantity: parseInt(qty) })
        });
        const data = await res.json();
        alert(data.message || data.error);
        fetchSweets();
    }

    async function deleteSweet(id) {
        if (!confirm('Are you sure you want to delete this sweet?')) return;
        const res = await fetch(`/shop/api/sweets/${id}/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });
        const data = await res.json();
        alert(data.message || 'Sweet deleted');
        fetchSweets();
    }

    // Load all sweets initially
    fetchSweets();
</script>

</body>
</html>
